<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Probability Monad</title>
<meta name="author" content="(Tikhon Jelvis)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/css/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/css/theme/tikhon.css" id="theme"/>

<link rel="stylesheet" href="./reveal.js/lib/css/zenburn.css"/>
<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
<meta name="description" content="Probability distributions form a monad. I'll talk about how we can use this monad in different ways to work with probability distributions in our code.">
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h1 class="title">Probability Monad</h1><h2 class="author">Tikhon Jelvis</h2><h2 class="email"><a href="mailto:tikhon@jelv.is">tikhon@jelv.is</a></h2>
</section>

<section>
<section id="slide-org223575c">
<h2 id="org223575c"></h2>
<ol>
<li>Probability Distributions</li>
<li>Interpretations</li>
<li>Supply Chain Optimization</li>
<li>Probabilistic Programming</li>

</ol>

</section>
</section>
<section>
<section id="slide-org1ef44e6">
<h2 id="org1ef44e6"></h2>
<div class="org-src-container">

<pre><code class="haskell" >dice = uniform [1..6]
</code></pre>
</div>

<div class="figure">
<p><img src="./img/dice.png" alt="dice.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-org979bfb4">
<h2 id="org979bfb4"></h2>
<div class="org-src-container">

<pre><code class="haskell" >dice2 = dice + dice
</code></pre>
</div>

<div class="figure">
<p><img src="./img/dice2.png" alt="dice2.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-orgfb487a9">
<h2 id="orgfb487a9">Abstract Type</h2>
<div class="org-src-container">

<pre><code class="haskell" >data Dist a = ...

dice ∷ Dist Int
dice = uniform [1..6]

coin ∷ Double → Dist Coin
coin p = 
  weighted [(T, p), (H, 1 - p)]
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org0fee190">
<h2 id="org0fee190">Monad</h2>
<div class="org-src-container">

<pre><code class="haskell" >pure ∷ a → Dist a
fmap ∷ (a → b) → (Dist a → Dist b)
join ∷ Dist (Dist a) → Dist a
</code></pre>
</div>

<ul>
<li>remember <code>flatMap</code> or <code>bind</code>:</li>

</ul>
<div class="org-src-container">

<pre><code class="haskell" >x &gt;&gt;= f = join (fmap f x)
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org19dc558">
<h2 id="org19dc558">pure</h2>
<div class="org-src-container">

<pre><code class="haskell" >pure x = uniform [x]
</code></pre>
</div>

<div class="figure">
<p><img src="./img/constant.png" alt="constant.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-orgd295807">
<h2 id="orgd295807">fmap</h2>
<div class="org-src-container">

<pre><code class="haskell" >fmap (`mod` 5) dice2
</code></pre>
</div>
<img src="./img/dice2-small.png" />
<span style="position: relative; bottom: 175px; font-size: 60pt"> ⇒ </span>
<img src="./img/divisible.png" />

</section>
</section>
<section>
<section id="slide-org511aef2">
<h2 id="org511aef2">join</h2>
<div class="org-src-container">

<pre><code class="haskell" >join ∷ Dist (Dist a) → Dist a
</code></pre>
</div>

<p>
Two different interpretations.
</p>

</section>
</section>
<section>
<section id="slide-org8b38b50">
<h2 id="org8b38b50"></h2>
<div class="org-src-container">

<pre><code class="haskell" >data Coin = H | T

coin ∷ Double → Dist Coin
coin p = weighted [(T, p), (H, 1 - p)]

fair   = coin 0.5
unfair = coin 0.9
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org8269836">
<h2 id="org8269836"></h2>
<div class="org-src-container">

<pre><code class="haskell" >randomCoin ∷ Dist (Dist Coin)
randomCoin = 
  weighted [ (fair,   0.5)
           , (unfair, 0.5)
           ]
</code></pre>
</div>

<div class="org-src-container">

<pre class="fragment roll-in"><code class="haskell" >join randomCoin ∷ Dist Coin
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org2edcfdf">
<h2 id="org2edcfdf">Sampling</h2>
<div class="org-src-container">

<pre><code class="haskell" >randomCoin ∷ Dist (Dist Coin)
randomCoin = …
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >flattened ∷ Dist Coin
flattened = do
  coinDist ← randomCoin
  result   ← coinDist
  return result
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-orgbbe6198">
<h2 id="orgbbe6198">Exhaustive</h2>
<div class="org-src-container">

<pre><code class="haskell" >fair, unfair ∷ Dist Coin
fair   = coin 0.5
unfair = coin 0.9
</code></pre>
</div>


<p>
<img src="./img/flipTree.png" alt="flipTree.png" /> <img src="./img/flipTree'.png" alt="flipTree'.png" />
</p>

</section>
</section>
<section>
<section id="slide-org0e7766f">
<h2 id="org0e7766f"></h2>
<div class="org-src-container">

<pre><code class="haskell" >randomCoin ∷ Dist (Dist Coin)
randomCoin = weighted [ (0.5, coin 0.5)
                      , (0.5, coin 0.9) 
                      ]
</code></pre>
</div>


<div class="figure">
<p><img src="./img/nested.png" alt="nested.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-org6e3c04c">
<h2 id="org6e3c04c">flattened</h2>

<div class="figure">
<p><img src="./img/flattened.png" alt="flattened.png" />
</p>
</div>

<div class="org-src-container">

<pre><code class="haskell" >[ (H, 0.25), (T, 0.25)
, (H, 0.05), (T, 0.45) ]
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org84b19c8">
<h2 id="org84b19c8"></h2>
<div class="org-src-container">

<pre><code class="haskell" >result = join randomCoin
</code></pre>
</div>


<div class="figure">
<p><img src="./img/final.png" alt="final.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-orgac92c03">
<h2 id="orgac92c03">Implementations</h2>

</section>
</section>
<section>
<section id="slide-org7287a91">
<h2 id="org7287a91">Sampling</h2>
<p>
pseudorandom number generators
</p>

<div class="org-src-container">

<pre><code class="haskell" >sample ∷ Gen → (Double, Gen)

type Random a = State Gen a 

run   ∷ Seed → Random a → a
runIO ∷ Random a → IO a
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org6fcc308">
<h2 id="org6fcc308">Exhaustive</h2>

<div class="figure">
<p><img src="./img/erwig-fpf.png" alt="erwig-fpf.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-org8c23644">
<h2 id="org8c23644">Exhaustive</h2>
<div class="org-src-container">

<pre><code class="haskell" >type Probability = Double 
  -- or Rational or...

newtype Dist a = Dist 
  { probabilities ∷ [(a, Probability)] }
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org56e4a4f">
<h2 id="org56e4a4f">Exhaustive</h2>
<div class="org-src-container">

<pre><code class="haskell" >weighted ∷ [(a, Probability)] → Dist a
weighted = Dist

uniform ∷ [a] → Dist a
uniform xs = Dist (zip xs [1..])
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-orga942ae3">
<h2 id="orga942ae3">Monad</h2>
<div class="org-src-container">

<pre><code class="haskell" >pure ∷ a → Dist a
pure x = Dist [(x, 1)]

join ∷ Dist (Dist a) → Dist a
join dists = Dist 
  [ (x, p₁ * p₂) | (d, p₁) ← dists
                 , (x, p₂) ← d ]
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org5f2fd0e">
<h2 id="org5f2fd0e">Monad</h2>

<div class="figure">
<p><img src="./img/nested.png" alt="nested.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-org93d346c">
<h2 id="org93d346c">Unnormalized</h2>

<div class="figure">
<p><img src="./img/flattened.png" alt="flattened.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-orgede08a3">
<h2 id="orgede08a3"></h2>
<img src="./img/flattened.png" />
<div>
⇓ 
</div>
<img src="./img/final.png" />

</section>
</section>
<section>
<section id="slide-org1cb6d07">
<h2 id="org1cb6d07">Normalizing</h2>
<div class="org-src-container">

<pre><code class="haskell" >normalize ∷ Ord a ⇒ Dist a → Dist a
normalize = ...
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org3d47326">
<h2 id="org3d47326">Normalize automatically?</h2>
<div class="org-src-container">

<pre class="fragment roll-in"><code class="haskell" >fmap (+) dice ∷ Dist (a → b)
</code></pre>
</div>

<div class="org-src-container">

<pre class="fragment roll-in"><code class="haskell" >(+) &lt;$&gt; dice &lt;*&gt; dice

((+) &lt;$&gt; dice) ∷ Dist (a → b)
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org827451b">
<h2 id="org827451b">Upsides</h2>
<ul>
<li>expressive</li>
<li>intuitive</li>
<li>fits well into Haskell</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgb865c06">
<h2 id="orgb865c06">Downsides</h2>
<ul>
<li>sloooooow</li>
<li>normalization</li>

</ul>

</section>
</section>
<section>
<section id="slide-orga1e87c1">
<h2 id="orga1e87c1">Simple Abstractions Scale</h2>

</section>
</section>
<section>
<section id="slide-orgf394a46">
<h2 id="orgf394a46">Supply Chain Optimization</h2>

</section>
</section>
<section>
<section id="slide-org002a355">
<h2 id="org002a355"></h2>
<img src="./img/target.png" style="background:white" />

</section>
</section>
<section>
<section id="slide-org9778375">
<h2 id="org9778375">What is Target?</h2>
<ul>
<li>1806 stores</li>
<li>37 distribution centers</li>
<li>Target.com</li>

</ul>

</section>
</section>
<section>
<section id="slide-org323d6a8">
<h2 id="org323d6a8">Distribution Centers</h2>

<div class="figure">
<p><img src="./img/dc-map.png" alt="dc-map.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-org5df4147">
<h2 id="org5df4147">Maximize Experience; Minimize Cost</h2>

</section>
</section>
<section>
<section id="slide-orge3d8add">
<h2 id="orge3d8add">Demand Uncertainty</h2>

<div class="figure">
<p><img src="./img/binomial-demand.png" alt="binomial-demand.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-org0a94fe3">
<h2 id="org0a94fe3">Demand Uncertainty</h2>

<div class="figure">
<p><img src="./img/item-demand.png" alt="item-demand.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-orgb61331c">
<h2 id="orgb61331c"></h2>
<div class="org-src-container">

<pre><code class="haskell" >class Monad m ⇒ MonadDist m where
  weighted ∷ [(a, Probability)] → m a

  uniform  ∷ [a] → m a
  binomial ∷ Double → Int → m Int
  {- etc -}
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >instance MonadDist Dist
instance MonadDist Random
…
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org814bbbb">
<h2 id="org814bbbb">Models</h2>
<ul>
<li>sampling:
<ul>
<li>simulation</li>
<li>simulation-based optimization</li>

</ul></li>
<li>exhaustive:
<ul>
<li>linear programming</li>
<li>dynamic programming</li>

</ul></li>

</ul>

</section>
</section>
<section>
<section id="slide-org53b0258">
<h2 id="org53b0258">Random</h2>
<p>
easy(ish) to try different generators
</p>

<div class="org-src-container">

<pre><code class="haskell" >newtype Random a = Random {
  runRandom ∷ ∀ m. PrimMonad m 
            ⇒ Gen (PrimState m) → m a
} deriving Functor
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org048f28c">
<h2 id="org048f28c">Markov Decision Processes</h2>
<ul>
<li>S: set of states</li>
<li>A: set of actions</li>
<li>P(s, a, s'): transition probability</li>
<li>R(s, s'): reward</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgd4b52ab">
<h2 id="orgd4b52ab">Policy</h2>
<ul>
<li>result of optimization
<ul>
<li>function S → A</li>
<li>maximizes expected reward</li>

</ul></li>

</ul>

</section>
</section>
<section>
<section id="slide-org2b38d88">
<h2 id="org2b38d88">In Haskell</h2>
<div class="org-src-container">

<pre><code class="haskell" >data MDP m s a r = 
  MDP { step ∷ s → a → m (r, s) }

type Policy s a = s → a
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org509945e">
<h2 id="org509945e">Simulation</h2>
<div class="org-src-container">

<pre><code class="haskell" >data Markov m s r = 
  Markov { step ∷ s → m (s, r) }

apply ∷ MDP m s a r 
      → Policy s a 
      → Markov m s r
</code></pre>
</div>


</section>
</section>
<section>
<section id="slide-org429aa79">
<h2 id="org429aa79">Example</h2>

</section>
</section>
<section>
<section id="slide-orgd972fc8">
<h2 id="orgd972fc8"></h2>
<div class="org-src-container">

<pre><code class="haskell" >step ∷ Qty → Qty → m (Qty, Money)
step inv order = do
  let stocked = inv + order
      cost    = price * order

  buyers ← demand

  let after  = max (stocked - buyers) 0
      profit = price * (inv - after)

  return (remaining, profit - cost)
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-orgad9b583">
<h2 id="orgad9b583">Optimization Techniques</h2>
<ul>
<li>dynamic programming (policy iteration)</li>
<li>linear programming</li>
<li>reinforcement learning
<ul>
<li>features</li>
<li>neural nets</li>

</ul></li>
<li>domain-specific algorithms</li>

</ul>

</section>
</section>
<section>
<section id="slide-org8a40aad">
<h2 id="org8a40aad">Free Monads</h2>

<div class="figure">
<p><img src="./img/prac-prob.png" alt="prac-prob.png" />
</p>
</div>

</section>
</section>
<section>
<section id="slide-org18a49a1">
<h2 id="org18a49a1">Free Monad</h2>
<div class="org-src-container">

<pre><code class="haskell" >data D a where
  Return      ∷ a → D a
  Bind        ∷ D b → (b → D a) → D a
  Primitive   ∷ Sampleable d ⇒ d a → D a
  Conditional ∷ (a → Prob) → D a → D a
</code></pre>
</div>

<div class="org-src-container">

<pre><code class="haskell" >instance Monad Dist where
  return = Pure
  (&gt;&gt;=)  = Bind
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org0289dd0">
<h2 id="org0289dd0">Future?</h2>
<ul>
<li>full-on probabilistic programming</li>
<li>interactive Haskell-based tools</li>
<li>distributions optimized for optimization?</li>

</ul>

</section>
</section>
<section>
<section id="slide-org1638f38">
<h2 id="org1638f38">We're Hiring!</h2>
<p>
Sounds interesting? 
</p>

<p>
Email me: tikhon.jelvis@target.com
</p>

</section>
</section>
<section>
<section id="slide-org7fa8ce1">
<h2 id="org7fa8ce1">Questions?</h2>
</section>
</section>
</div>
</div>
<p> Created by Tikhon Jelvis. </p>
<script src="./reveal.js/lib/js/head.min.js"></script>
<script src="./reveal.js/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: false,
progress: false,
history: true,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
overview: true,
width: 1200,
height: 800,
margin: 0.10,
minScale: 0.50,
maxScale: 2.50,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'slide', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: './reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
 { src: './reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
